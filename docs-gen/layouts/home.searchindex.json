{{- $pages := where .Site.RegularPages "Kind" "page" -}}
{{- $searchExclKinds := .Site.Params.doks.searchExclKinds | default slice -}}
{{- $searchExclTypes := .Site.Params.doks.searchExclTypes | default slice -}}
{{- $showSearch := .Site.Params.doks.showSearch | default slice -}}
{{- $indexSummary := .Site.Params.doks.indexSummary | default false -}}
{{/* DEBUG: Comment to see what values we get */}}
{{/* BaseURL: {{ .Site.BaseURL }} */}}
{{/* Title: {{ .Site.Title }} */}}

{{- if gt (len $showSearch) 0 -}}
  {{- $pages = where $pages "Section" "in" $showSearch -}}
{{- end -}}

{{- if gt (len $searchExclKinds) 0 -}}
  {{- $pages = where $pages "Kind" "not in" $searchExclKinds -}}
{{- end -}}

{{- if gt (len $searchExclTypes) 0 -}}
  {{- $pages = where $pages "Type" "not in" $searchExclTypes -}}
{{- end -}}

[
{{- range $index, $page := $pages -}}
  {{- if gt $index 0 }},{{ end }}
  {{- $permalink := $page.Permalink -}}
  {{- if or (eq $permalink $page.RelPermalink) (not (hasPrefix $permalink "http")) -}}
    {{- if eq hugo.Environment "production" -}}
      {{- $permalink = printf "https://giaccomole.github.io/s2dm%s" $page.RelPermalink -}}
    {{- else -}}
      {{- $permalink = printf "%s%s" .Site.BaseURL $page.RelPermalink -}}
    {{- end -}}
  {{- end -}}
  {
    "id": {{ $index }},
    "title": {{ $page.Title | jsonify }},
    "permalink": {{ $permalink | jsonify }},
    "summary": {{ if $indexSummary }}{{ $page.Summary | plainify | jsonify }}{{ else }}{{ $page.Summary | plainify | jsonify }}{{ end }},
    "content": {{ if $indexSummary }}{{ $page.Summary | plainify | jsonify }}{{ else }}{{ $page.Content | plainify | jsonify }}{{ end }},
    "date": {{ $page.Date.Format "2006-01-02" | jsonify }},
    "tags": {{ $page.Params.tags | jsonify }}
  }
{{- end -}}
]
