{{/* GraphQL Voyager Shortcode
  Parameters:
  - schema: path to the GraphQL schema file (relative to static directory)
  - height: height of the container (default: 600px)
  - title: optional title to display above the visualization
  - skipRelay: skip relay-related entities (default: true)
  - skipDeprecated: skip deprecated fields (default: true)
  - sortByAlphabet: sort fields alphabetically (default: false)
  - showLeafFields: show scalar and enum fields (default: true)
  - hideRoot: hide the root type (default: false)
  - hideDocs: hide the documentation sidebar (default: false)
  - hideSettings: hide the settings panel (default: false)
  - allowToChangeSchema: allow users to change schema (default: false)
*/}}

{{ $schema := .Get "schema" | default "schema.graphql" }}
{{ $height := .Get "height" | default "600px" }}
{{ $title := .Get "title" }}
{{ $skipRelay := .Get "skipRelay" | default "true" }}
{{ $skipDeprecated := .Get "skipDeprecated" | default "true" }}
{{ $sortByAlphabet := .Get "sortByAlphabet" | default "false" }}
{{ $showLeafFields := .Get "showLeafFields" | default "true" }}
{{ $hideRoot := .Get "hideRoot" | default "false" }}
{{ $hideDocs := .Get "hideDocs" | default "false" }}
{{ $hideSettings := .Get "hideSettings" | default "false" }}
{{ $allowToChangeSchema := .Get "allowToChangeSchema" | default "false" }}
{{ $containerClass := .Get "class" | default "graphql-voyager-container" }}

{{ $containerId := printf "voyager-%d" .Ordinal }}

<div class="{{ $containerClass }}">
  {{ if $title }}
  <h3 class="graphql-voyager-title">{{ $title }}</h3>
  {{ end }}
  <div id="{{ $containerId }}" style="height: {{ $height }};">
    <div class="graphql-voyager-loading">
      <div>Loading GraphQL Schema Visualization...</div>
    </div>
  </div>
</div>

<script>
(function() {
  const containerId = '{{ $containerId }}';
  const schemaPath = '{{ $schema }}';
  const container = document.getElementById(containerId);
  
  // Show loading state
  function showLoading() {
    container.innerHTML = '<div class="graphql-voyager-loading">Loading GraphQL Schema...</div>';
  }
  
  // Show error state
  function showError(message) {
    container.innerHTML = '<div class="graphql-voyager-error">Error loading schema: ' + message + '</div>';
  }
  
  // Wait for GraphQL Voyager to be available
  function waitForVoyager(callback) {
    if (typeof GraphQLVoyager !== 'undefined') {
      callback();
    } else {
      setTimeout(() => waitForVoyager(callback), 100);
    }
  }
  
  // Load and render the schema
  function loadSchema() {
    // For Hugo, we need to construct the path to the assets
    const fullSchemaPath = schemaPath.startsWith('/') ? schemaPath : '/' + schemaPath;
    
    fetch(fullSchemaPath)
      .then(response => {
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        return response.text();
      })
      .then(sdlText => {
        if (!sdlText.trim()) {
          throw new Error('Schema file is empty');
        }
        
        console.log('SDL loaded, length:', sdlText.length);
        console.log('SDL preview:', sdlText.substring(0, 200));
        
        waitForVoyager(() => {
          try {
            console.log('Converting SDL to schema using GraphQL buildSchema');
            
            // Use GraphQL's buildSchema to create a proper schema object
            let introspectionResult;
            
            if (typeof GraphQL !== 'undefined' && GraphQL.buildSchema) {
              console.log('Using GraphQL.buildSchema');
              const schema = GraphQL.buildSchema(sdlText);
              introspectionResult = GraphQL.getIntrospectionQuery ? 
                GraphQL.introspectionFromSchema(schema) : 
                { data: { __schema: schema } };
            } else if (typeof GraphQLVoyager.sdlToSchema === 'function') {
              console.log('Using GraphQLVoyager.sdlToSchema');
              introspectionResult = GraphQLVoyager.sdlToSchema(sdlText);
            } else {
              console.log('No schema conversion available, passing SDL directly');
              introspectionResult = null;
            }
            
            console.log('Schema conversion result:', introspectionResult);
            
            // Clear the container
            container.innerHTML = '';
            
            // Configure Voyager options - enable documentation and full features
            const voyagerOptions = {};
            
            // If we have introspection result, use it; otherwise pass SDL directly
            if (introspectionResult) {
              voyagerOptions.introspection = introspectionResult;
            } else {
              // Try passing SDL directly - Voyager might handle it internally
              voyagerOptions.schemaSDL = sdlText;
            }
            
            // Add display options using template variables
            const skipRelay = {{ if eq $skipRelay "true" }}true{{ else }}false{{ end }};
            const skipDeprecated = {{ if eq $skipDeprecated "true" }}true{{ else }}false{{ end }};
            const sortByAlphabet = {{ if eq $sortByAlphabet "true" }}true{{ else }}false{{ end }};
            const showLeafFields = {{ if eq $showLeafFields "true" }}true{{ else }}false{{ end }};
            const hideRoot = {{ if eq $hideRoot "true" }}true{{ else }}false{{ end }};
            const hideDocs = {{ if eq $hideDocs "true" }}true{{ else }}false{{ end }};
            const hideSettings = {{ if eq $hideSettings "true" }}true{{ else }}false{{ end }};
            const allowToChangeSchema = {{ if eq $allowToChangeSchema "true" }}true{{ else }}false{{ end }};
            
            voyagerOptions.displayOptions = {
              skipRelay: skipRelay,
              skipDeprecated: skipDeprecated,
              sortByAlphabet: sortByAlphabet,
              showLeafFields: showLeafFields,
              hideRoot: hideRoot
            };
            
            // Add UI options
            voyagerOptions.hideDocs = hideDocs;
            voyagerOptions.hideSettings = hideSettings;
            voyagerOptions.allowToChangeSchema = allowToChangeSchema;
            
            console.log('Voyager options:', voyagerOptions);
            
            // Render the voyager
            GraphQLVoyager.renderVoyager(container, voyagerOptions);
            
            console.log('GraphQL Voyager rendered successfully');
          } catch (error) {
            console.error('Error converting SDL to schema:', error);
            showError('Invalid GraphQL schema: ' + error.message);
          }
        });
      })
      .catch(error => {
        console.error('GraphQL Voyager error:', error);
        showError(error.message);
      });
  }
  
  // Start loading when DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', loadSchema);
  } else {
    loadSchema();
  }
})();
</script>
